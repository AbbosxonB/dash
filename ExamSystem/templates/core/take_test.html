{% extends 'base.html' %}

{% block title %}{{ test.test_name }} - Exam System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>{{ test.test_name }}</h2>
        <p>Subject: {{ test.subject.name }} | Time: {{ test.total_time_minutes }} minutes</p>
    </div>
</div>

<form method="post" id="test-form">
    {% csrf_token %}
    
    <!-- Hidden input to store time taken -->
    <input type="hidden" name="time_taken" id="time_taken" value="0">
    
    <!-- Timer Display -->
    <div class="test-timer">
        <div id="timer">Time remaining: <span id="time-display">{{ test.total_time_minutes }}:00</span></div>
    </div>
    
    <!-- Question Navigation -->
    <div class="question-nav">
        <h6>Question Navigation</h6>
        <div class="d-flex flex-wrap">
            {% for question in questions %}
                <a href="#question-{{ question.id }}" class="btn btn-sm btn-outline-light m-1 nav-item" onclick="highlightQuestion({{ question.id }})">
                    {{ forloop.counter }}
                </a>
            {% endfor %}
        </div>
    </div>
    
    <div class="row mt-5">
        <div class="col-md-9">
            {% for question in questions %}
            <div class="card question-card" id="question-{{ question.id }}">
                <div class="card-body">
                    <h5 class="card-title">Question {{ forloop.counter }}: {{ question.question_text }}</h5>
                    <p class="card-text"><small class="text-muted">Points: {{ question.points_value }}</small></p>
                    
                    {% if question.question_type == 'MCQ' %}
                        {% for answer in question.answers.all %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}">
                            <label class="form-check-label" for="answer_{{ answer.id }}">
                                {{ answer.answer_text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% elif question.question_type == 'TF' %}
                        {% for answer in question.answers.all %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}">
                            <label class="form-check-label" for="answer_{{ answer.id }}">
                                {{ answer.answer_text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% elif question.question_type == 'ESSAY' %}
                        <textarea class="form-control" name="question_{{ question.id }}" rows="4" placeholder="Write your answer here..."></textarea>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg" id="submit-btn">Submit Test</button>
                <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Cancel Test</a>
            </div>
        </div>
    </div>
</form>

<script>
let timeRemaining = {{ test.total_time_minutes }} * 60; // Convert to seconds
let timerInterval;

function updateTimer() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    document.getElementById('time-display').textContent = 
        minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
    
    // Update hidden field with time taken
    const timeTaken = ({{ test.total_time_minutes }} * 60) - timeRemaining;
    document.getElementById('time_taken').value = timeTaken;
    
    if (timeRemaining <= 0) {
        // Time's up! Submit the form automatically
        clearInterval(timerInterval);
        document.getElementById('test-form').submit();
    }
    
    timeRemaining--;
}

// Start the timer
timerInterval = setInterval(updateTimer, 1000);

// Function to highlight the selected question in navigation
function highlightQuestion(questionId) {
    // Remove highlight from all nav items
    document.querySelectorAll('.question-nav .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-light');
    });
    
    // Add highlight to the clicked question
    const navBtn = document.querySelector(`[href="#question-${questionId}"]`);
    if (navBtn) {
        navBtn.classList.remove('btn-outline-light');
        navBtn.classList.add('btn-primary');
    }
    
    // Scroll to the question
    document.getElementById(`question-${questionId}`).scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

// Handle form submission confirmation
document.getElementById('test-form').addEventListener('submit', function(e) {
    if (!confirm('Are you sure you want to submit your test?')) {
        e.preventDefault();
    }
});

// Update time taken field on form submission
document.getElementById('test-form').addEventListener('submit', function() {
    // Calculate and update the time taken before submission
    const timeTaken = ({{ test.total_time_minutes }} * 60) - timeRemaining;
    document.getElementById('time_taken').value = timeTaken;
});
</script>
{% endblock %}