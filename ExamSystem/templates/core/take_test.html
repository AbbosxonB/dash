{% extends 'base.html' %}

{% block title %}{{ test.test_name }} - Exam System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>{{ test.test_name }}</h2>
        <p>Subject: {{ test.subject.name }} | Time: {{ test.total_time_minutes }} minutes</p>
    </div>
</div>

<form method="post" id="test-form" action="{% url 'submit_test' test.id %}">
    {% csrf_token %}
    <input type="hidden" name="time_taken" id="time_taken" value="0">

    <div class="row">
        <!-- Main Content: Questions -->
        <div class="col-md-10">
            {% for question in questions %}
            <div class="card mb-3" id="question-{{ question.id }}">
                <div class="card-body">
                    <h5 class="card-title">Question {{ forloop.counter }}: {{ question.question_text }}</h5>
                    <p class="card-text"><small class="text-muted">Points: {{ question.points_value }}</small></p>

                    {% if question.question_type == 'MCQ' %}
                        {% for answer in question.answers.all %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}">
                            <label class="form-check-label" for="answer_{{ answer.id }}">
                                {{ answer.answer_text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% elif question.question_type == 'TF' %}
                        {% for answer in question.answers.all %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}">
                            <label class="form-check-label" for="answer_{{ answer.id }}">
                                {{ answer.answer_text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% elif question.question_type == 'ESSAY' %}
                        <textarea class="form-control" name="question_{{ question.id }}" rows="4" placeholder="Write your answer here..."></textarea>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-success btn-lg" id="submit-btn">Submit Test</button>
                <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">Cancel Test</a>
            </div>
        </div>

        <!-- Sidebar: Timer and Navigation -->
        <div class="col-md-2">
            <div class="sticky-top">
                <!-- Timer Display -->
                <div class="card mb-3">
                    <div class="card-header">Time Remaining</div>
                    <div class="card-body text-center">
                        <h4 id="time-display">{{ test.total_time_minutes }}:00</h4>
                    </div>
                </div>

                <!-- Question Navigation -->
                <div class="card">
                    <div class="card-header">
                        Question Navigation (<span id="answered-count">0</span>/{{ questions|length }})
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap">
                            {% for question in questions %}
                                <a href="#question-{{ question.id }}" class="btn btn-sm btn-outline-secondary m-1 nav-item" id="nav-btn-{{ question.id }}" onclick="highlightQuestion('{{ question.id }}', event)">
                                    {{ forloop.counter }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const testForm = document.getElementById('test-form');
    const timeDisplay = document.getElementById('time-display');
    const timeTakenInput = document.getElementById('time_taken');
    const answeredCountEl = document.getElementById('answered-count');

    let totalTestMinutes = parseInt("{{ test.total_time_minutes }}");
    if (isNaN(totalTestMinutes) || totalTestMinutes <= 0) {
        totalTestMinutes = 0;
    }

    let timeRemaining = totalTestMinutes * 60; // in seconds
    let timerInterval;
    const questions = document.querySelectorAll('.card[id^="question-"]');

    function updateAnsweredState() {
        let answeredCount = 0;
        questions.forEach(questionCard => {
            const questionId = questionCard.id.replace('question-', '');
            let isAnswered = false;

            const radioInputs = questionCard.querySelectorAll(`input[type="radio"][name="question_${questionId}"]`);
            if (radioInputs.length > 0) {
                if (Array.from(radioInputs).some(radio => radio.checked)) {
                    isAnswered = true;
                }
            }

            const textareaInput = questionCard.querySelector(`textarea[name="question_${questionId}"]`);
            if (textareaInput && textareaInput.value.trim() !== '') {
                isAnswered = true;
            }

            const navBtn = document.getElementById(`nav-btn-${questionId}`);
            if (navBtn) {
                if (isAnswered) {
                    answeredCount++;
                    navBtn.classList.add('btn-info');
                    navBtn.classList.remove('btn-outline-secondary');
                } else {
                    navBtn.classList.remove('btn-info');
                    navBtn.classList.add('btn-outline-secondary');
                }
            }
        });
        answeredCountEl.textContent = answeredCount;
    }

    window.highlightQuestion = (questionId, event) => {
        if(event) event.preventDefault();
        
        // Update active visual for nav buttons
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.classList.remove('btn-primary');
        });
        const navBtn = document.getElementById(`nav-btn-${questionId}`);
        if (navBtn) {
            navBtn.classList.add('btn-primary');
        }

        // Scroll question into view
        const questionEl = document.getElementById(`question-${questionId}`);
        if(questionEl) {
            questionEl.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    };
    
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        let seconds = timeRemaining % 60;
        seconds = seconds < 10 ? '0' + seconds : seconds;

        timeDisplay.textContent = `${minutes}:${seconds}`;
        timeTakenInput.value = (totalTestMinutes * 60) - timeRemaining;

        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert("Time's up! Submitting your test.");
            testForm.submit();
        }
        timeRemaining--;
    }

    if (timeRemaining > 0) {
        timerInterval = setInterval(updateTimer, 1000);
    } else {
        timeDisplay.textContent = '0:00';
    }

    testForm.addEventListener('submit', function(e) {
        if (!confirm('Are you sure you want to submit your test?')) {
            e.preventDefault();
        } else {
            clearInterval(timerInterval); // Stop timer on manual submit
            timeTakenInput.value = (totalTestMinutes * 60) - timeRemaining;
        }
    });

    // Add event listeners to form inputs to track answered status
    testForm.querySelectorAll('input[type="radio"], textarea').forEach(input => {
        input.addEventListener('input', updateAnsweredState);
        input.addEventListener('change', updateAnsweredState);
    });

    // Initial state update
    updateAnsweredState();
});
</script>
{% endblock %}